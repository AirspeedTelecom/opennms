<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
		http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

    <changeSet author="rangerrick" id="1.7.8-remove-old-primary-key-if-necessary" failOnError="false">
        <preConditions onFail="MARK_RAN">
            <primaryKeyExists tableName="datalinkinterface" primaryKeyName="pk_datalinkinterface" />
        </preConditions>
        <dropPrimaryKey tableName="datalinkinterface" constraintName="pk_datalinkinterface" />
        <addPrimaryKey tableName="datalinkinterface" columnNames="id" />
    </changeSet>

	<changeSet author="rangerrick" id="1.7.8-add-linkState">
		<createTable tableName="linkstate">
			<column name="id" type="integer" autoIncrement="true">
				<constraints nullable="false"  primaryKey="true" />
			</column>
			<column name="datalinkinterfaceid" type="integer">
				<constraints nullable="false" />
			</column>
			<column name="linkstate" type="VARCHAR(24)" defaultValue="LINK_UP" />
		</createTable>

		<addForeignKeyConstraint constraintName="fk_linkstate_datalinkinterface_id" onDelete="CASCADE"
			baseTableName="linkstate" baseColumnNames="datalinkinterfaceid"
			referencedTableName="datalinkinterface" referencedColumnNames="id" />

		<rollback>
			<dropForeignKeyConstraint baseTableName="linkstate" constraintName="fk_linkstate_datalinkinterface_id" />
			<dropTable tableName="linkstate" />
		</rollback>

		<modifySql>
			<replace replace=" serial " with=" integer DEFAULT nextval('opennmsNxtId') " />
		</modifySql>

	</changeSet>
	
	<changeSet author="thedesloge" id="1.7.8-update-linkstate">
		<modifyColumn tableName="linkstate">
    		<column name="linkstate" type="varchar(32)"/>
		</modifyColumn>
	</changeSet>

</databaseChangeLog>
